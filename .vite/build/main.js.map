{"version":3,"file":"main.js","sources":["../../public/main.ts"],"sourcesContent":["import { app, BrowserWindow, ipcMain, IpcMainInvokeEvent } from 'electron';\nimport { join } from 'path';\nimport { autoUpdater } from 'electron-updater';\nimport { networkInterfaces } from 'os';\nimport { existsSync, writeFileSync, readFileSync } from 'fs';\nimport { fork, ChildProcess } from 'child_process';\nimport { EventEmitter } from 'events';\n\n// Vite defines these constants for Electron Forge\ndeclare const MAIN_WINDOW_VITE_DEV_SERVER_URL: string;\ndeclare const MAIN_WINDOW_VITE_NAME: string;\n\n// Suppress CSP warnings in development\nprocess.env.ELECTRON_DISABLE_SECURITY_WARNINGS = 'true';\n\ninterface Config {\n  venueIP: string;\n  interface: {\n    name: string;\n    address: string;\n  };\n}\n\ninterface ArtNetMessage {\n  cmd: string;\n  universes?: any;\n  error?: string;\n  result?: any;\n  data?: any;\n}\n\nconst myEmitter = new EventEmitter();\n\nlet win: BrowserWindow;\nlet activeInterface: any = null;\n\nconst pathToConfigFile = join(app.getPath('userData'), 'config.json');\nlet config: Config;\nconst defaultConfig: Config = { venueIP: '', interface: { name: '', address: '' } };\n\nconst saveConfig = (data: Config): void => {\n  writeFileSync(pathToConfigFile, JSON.stringify(data, null, '\\t'));\n  config = JSON.parse(readFileSync(pathToConfigFile, 'utf-8'));\n};\n\nif (!existsSync(pathToConfigFile)) {\n  saveConfig(defaultConfig);\n  console.log(\"Created Config File\");\n} else {\n  config = JSON.parse(readFileSync(pathToConfigFile, 'utf-8'));\n}\n\n// SECOND INSTANCE\nconst gotTheLock = app.requestSingleInstanceLock();\nif (!gotTheLock) {\n  app.quit();\n} else {\n  app.on('second-instance', () => {\n    if (win) {\n      if (win.isMinimized()) win.restore();\n      win.focus();\n    }\n  });\n}\n\n// In dev: __dirname is .vite/build, artNet.js is in public/\n// In prod: artNet.js is in extraResources\nconst artNetPath = app.isPackaged\n  ? join(process.resourcesPath, 'artNet.js')\n  : join(__dirname, '..', '..', 'public', 'artNet.js');\n\nconst artNet: ChildProcess = fork(artNetPath, { stdio: ['pipe', 'pipe', 'pipe', 'ipc'] });\nartNet.stdout?.pipe(process.stdout);\nartNet.stderr?.pipe(process.stdout);\n\nconst createWindow = (): void => {\n  win = new BrowserWindow({\n    width: 950,\n    height: 500,\n    autoHideMenuBar: true,\n    show: false,\n    title: 'DN bridge ' + app.getVersion(),\n    webPreferences: {\n      preload: join(__dirname, 'preload.js'),\n      sandbox: false\n    }\n  });\n\n  // Load the app using Vite constants\n  if (MAIN_WINDOW_VITE_DEV_SERVER_URL) {\n    win.loadURL(MAIN_WINDOW_VITE_DEV_SERVER_URL);\n  } else {\n    win.loadFile(join(__dirname, `../renderer/${MAIN_WINDOW_VITE_NAME}/index.html`));\n  }\n\n  win.on('closed', () => app.quit());\n  win.on('ready-to-show', () => win.show());\n};\n\napp.on('ready', async () => {\n  artNet.on('message', (msg: ArtNetMessage) => {\n    switch (msg.cmd) {\n      case 'universes':\n        try {\n          win.webContents.send('universes', msg.universes);\n        } catch (error) {\n          // Window not ready\n        }\n        break;\n\n      case 'startResult':\n        if (msg.error) {\n          console.log('start error', msg.error);\n          myEmitter.emit('startResult', msg);\n        } else {\n          myEmitter.emit('startResult', msg);\n        }\n        break;\n\n      case 'sendToVenueResult':\n        if (msg.error) {\n          console.log('start error', msg.error);\n          myEmitter.emit('sendToVenueResult', msg);\n        } else {\n          myEmitter.emit('sendToVenueResult', msg);\n        }\n        break;\n\n      default:\n        break;\n    }\n  });\n\n  artNet.on('error', (err) => { console.log(err); });\n  artNet.on('close', (err, msg) => { console.log(err, msg); });\n\n  const startUDP = async (): Promise<any> => {\n    console.log(\"IN START UDP\");\n    return new Promise(async (resolve, reject) => {\n      const handleResult = (msg: ArtNetMessage) => {\n        myEmitter.removeListener('startResult', handleResult);\n        if (msg.error) reject(msg.error);\n        resolve(msg.result);\n      };\n\n      setTimeout(() => {\n        myEmitter.removeListener('startResult', handleResult);\n        reject('start UDP timed out');\n      }, 5000);\n\n      myEmitter.on('startResult', handleResult);\n\n      artNet.send?.({ cmd: 'start', config });\n    });\n  };\n\n  const runServer = async (): Promise<void> => {\n    try {\n      const result = await startUDP();\n      activeInterface = result;\n      console.log('Run Server Result', result);\n    } catch (error) {\n      throw error;\n    }\n  };\n\n  if (networkInterfaces()[config.interface.name] !== undefined) {\n    const theIface = networkInterfaces()[config.interface.name]?.find(\n      (ifa) => ifa.address === config.interface.address\n    );\n    if (theIface !== undefined) runServer();\n  }\n\n  ipcMain.on('reactIsReady', () => {\n    win.webContents.send('message', 'React Is Ready');\n\n    if (app.isPackaged) {\n      win.webContents.send('message', 'App is packaged');\n\n      autoUpdater.on('error', (err) => win.webContents.send('updater', err));\n      autoUpdater.on('checking-for-update', () => win.webContents.send('updater', \"checking-for-update\"));\n      autoUpdater.on('update-available', (info) => win.webContents.send('updater', 'update-available', info));\n      autoUpdater.on('update-not-available', (info) => win.webContents.send('updater', 'update-not-available', info));\n      autoUpdater.on('download-progress', (info) => win.webContents.send('updater', 'download-progress', info));\n      autoUpdater.on('update-downloaded', (info) => win.webContents.send('updater', 'update-downloaded', info));\n\n      ipcMain.on('installUpdate', () => autoUpdater.quitAndInstall());\n\n      setTimeout(() => autoUpdater.checkForUpdates(), 3000);\n      setInterval(() => autoUpdater.checkForUpdates(), 1000 * 60 * 60);\n    }\n  });\n\n  createWindow();\n\n  ipcMain.handle('getInterface', () => activeInterface);\n  ipcMain.handle('getNetworkInterfaces', () => networkInterfaces());\n  ipcMain.handle('getVenueIP', () => config.venueIP);\n  \n  ipcMain.handle('setInterface', async (_e: IpcMainInvokeEvent, data: { name: string; address: string }) => {\n    return new Promise(async (resolve, reject) => {\n      let tempConfig = config;\n      tempConfig.interface = data;\n      saveConfig(tempConfig);\n      try {\n        const result = await startUDP();\n        console.log('Result in setInterface', result);\n        activeInterface = result;\n        resolve(activeInterface);\n      } catch (error) {\n        reject(error);\n      }\n    });\n  });\n\n  ipcMain.handle('setShowUniverses', (_e: IpcMainInvokeEvent, state: boolean) => {\n    if (state) {\n      artNet.send?.({ cmd: 'sendUniverses', value: true });\n      return true;\n    } else {\n      artNet.send?.({ cmd: 'sendUniverses', value: false });\n      return false;\n    }\n  });\n\n  const sendToVenue = async (yesNo: boolean, address?: string): Promise<any> => {\n    console.log(\"Send To Venue\", yesNo, address);\n    return new Promise(async (resolve, reject) => {\n      if (yesNo && address) {\n        let tempConfig = config;\n        tempConfig.venueIP = address;\n        saveConfig(tempConfig);\n      }\n\n      const handleSendToVenueResult = (msg: ArtNetMessage) => {\n        console.log(\"MESSAGE HERE\", msg);\n        myEmitter.removeListener('sendToVenueResult', handleSendToVenueResult);\n        resolve(msg.data);\n      };\n\n      setTimeout(() => {\n        myEmitter.removeListener('sendToVenueResult', handleSendToVenueResult);\n        reject('sendToVenue Timed Out');\n      }, 1000);\n\n      myEmitter.on('sendToVenueResult', handleSendToVenueResult);\n\n      artNet.send?.({ cmd: 'sendToVenue', value: yesNo, config });\n    });\n  };\n\n  ipcMain.handle('runSystem', async (_e: IpcMainInvokeEvent, address: string) => await sendToVenue(true, address));\n  ipcMain.handle('stopSystem', async () => await sendToVenue(false));\n\n  app.on('activate', () => { \n    if (BrowserWindow.getAllWindows().length === 0) createWindow();\n  });\n});\n\napp.on('will-quit', () => artNet.kill('SIGKILL'));\n\napp.on('window-all-closed', () => {\n  if (process.platform !== 'darwin') app.quit();\n});"],"names":["EventEmitter","join","app","writeFileSync","readFileSync","existsSync","fork","BrowserWindow","networkInterfaces","ipcMain","autoUpdater"],"mappings":";;;;;;;;AAaA,QAAQ,IAAI,qCAAqC;AAkBjD,MAAM,YAAY,IAAIA,OAAAA,aAAA;AAEtB,IAAI;AACJ,IAAI,kBAAuB;AAE3B,MAAM,mBAAmBC,KAAAA,KAAKC,SAAAA,IAAI,QAAQ,UAAU,GAAG,aAAa;AACpE,IAAI;AACJ,MAAM,gBAAwB,EAAE,SAAS,IAAI,WAAW,EAAE,MAAM,IAAI,SAAS,KAAG;AAEhF,MAAM,aAAa,CAAC,SAAuB;AACzCC,KAAAA,cAAc,kBAAkB,KAAK,UAAU,MAAM,MAAM,GAAI,CAAC;AAChE,WAAS,KAAK,MAAMC,GAAAA,aAAa,kBAAkB,OAAO,CAAC;AAC7D;AAEA,IAAI,CAACC,GAAAA,WAAW,gBAAgB,GAAG;AACjC,aAAW,aAAa;AACxB,UAAQ,IAAI,qBAAqB;AACnC,OAAO;AACL,WAAS,KAAK,MAAMD,GAAAA,aAAa,kBAAkB,OAAO,CAAC;AAC7D;AAGA,MAAM,aAAaF,SAAAA,IAAI,0BAAA;AACvB,IAAI,CAAC,YAAY;AACfA,WAAAA,IAAI,KAAA;AACN,OAAO;AACLA,eAAI,GAAG,mBAAmB,MAAM;AAC9B,QAAI,KAAK;AACP,UAAI,IAAI,cAAe,KAAI,QAAA;AAC3B,UAAI,MAAA;AAAA,IACN;AAAA,EACF,CAAC;AACH;AAIA,MAAM,aAAaA,SAAAA,IAAI,aACnBD,KAAAA,KAAK,QAAQ,eAAe,WAAW,IACvCA,KAAAA,KAAK,WAAW,MAAM,MAAM,UAAU,WAAW;AAErD,MAAM,SAAuBK,cAAAA,KAAK,YAAY,EAAE,OAAO,CAAC,QAAQ,QAAQ,QAAQ,KAAK,GAAG;AACxF,OAAO,QAAQ,KAAK,QAAQ,MAAM;AAClC,OAAO,QAAQ,KAAK,QAAQ,MAAM;AAElC,MAAM,eAAe,MAAY;AAC/B,QAAM,IAAIC,SAAAA,cAAc;AAAA,IACtB,OAAO;AAAA,IACP,QAAQ;AAAA,IACR,iBAAiB;AAAA,IACjB,MAAM;AAAA,IACN,OAAO,eAAeL,SAAAA,IAAI,WAAA;AAAA,IAC1B,gBAAgB;AAAA,MACd,SAASD,KAAAA,KAAK,WAAW,YAAY;AAAA,MACrC,SAAS;AAAA,IAAA;AAAA,EACX,CACD;AAGoC;AACnC,QAAI,QAAQ,uBAA+B;AAAA,EAC7C;AAIA,MAAI,GAAG,UAAU,MAAMC,SAAAA,IAAI,MAAM;AACjC,MAAI,GAAG,iBAAiB,MAAM,IAAI,MAAM;AAC1C;AAEAA,SAAAA,IAAI,GAAG,SAAS,YAAY;AAC1B,SAAO,GAAG,WAAW,CAAC,QAAuB;AAC3C,YAAQ,IAAI,KAAA;AAAA,MACV,KAAK;AACH,YAAI;AACF,cAAI,YAAY,KAAK,aAAa,IAAI,SAAS;AAAA,QACjD,SAAS,OAAO;AAAA,QAEhB;AACA;AAAA,MAEF,KAAK;AACH,YAAI,IAAI,OAAO;AACb,kBAAQ,IAAI,eAAe,IAAI,KAAK;AACpC,oBAAU,KAAK,eAAe,GAAG;AAAA,QACnC,OAAO;AACL,oBAAU,KAAK,eAAe,GAAG;AAAA,QACnC;AACA;AAAA,MAEF,KAAK;AACH,YAAI,IAAI,OAAO;AACb,kBAAQ,IAAI,eAAe,IAAI,KAAK;AACpC,oBAAU,KAAK,qBAAqB,GAAG;AAAA,QACzC,OAAO;AACL,oBAAU,KAAK,qBAAqB,GAAG;AAAA,QACzC;AACA;AAAA,IAGA;AAAA,EAEN,CAAC;AAED,SAAO,GAAG,SAAS,CAAC,QAAQ;AAAE,YAAQ,IAAI,GAAG;AAAA,EAAG,CAAC;AACjD,SAAO,GAAG,SAAS,CAAC,KAAK,QAAQ;AAAE,YAAQ,IAAI,KAAK,GAAG;AAAA,EAAG,CAAC;AAE3D,QAAM,WAAW,YAA0B;AACzC,YAAQ,IAAI,cAAc;AAC1B,WAAO,IAAI,QAAQ,OAAO,SAAS,WAAW;AAC5C,YAAM,eAAe,CAAC,QAAuB;AAC3C,kBAAU,eAAe,eAAe,YAAY;AACpD,YAAI,IAAI,MAAO,QAAO,IAAI,KAAK;AAC/B,gBAAQ,IAAI,MAAM;AAAA,MACpB;AAEA,iBAAW,MAAM;AACf,kBAAU,eAAe,eAAe,YAAY;AACpD,eAAO,qBAAqB;AAAA,MAC9B,GAAG,GAAI;AAEP,gBAAU,GAAG,eAAe,YAAY;AAExC,aAAO,OAAO,EAAE,KAAK,SAAS,QAAQ;AAAA,IACxC,CAAC;AAAA,EACH;AAEA,QAAM,YAAY,YAA2B;AAC3C,QAAI;AACF,YAAM,SAAS,MAAM,SAAA;AACrB,wBAAkB;AAClB,cAAQ,IAAI,qBAAqB,MAAM;AAAA,IACzC,SAAS,OAAO;AACd,YAAM;AAAA,IACR;AAAA,EACF;AAEA,MAAIM,GAAAA,oBAAoB,OAAO,UAAU,IAAI,MAAM,QAAW;AAC5D,UAAM,WAAWA,GAAAA,kBAAA,EAAoB,OAAO,UAAU,IAAI,GAAG;AAAA,MAC3D,CAAC,QAAQ,IAAI,YAAY,OAAO,UAAU;AAAA,IAAA;AAE5C,QAAI,aAAa,OAAW,WAAA;AAAA,EAC9B;AAEAC,mBAAQ,GAAG,gBAAgB,MAAM;AAC/B,QAAI,YAAY,KAAK,WAAW,gBAAgB;AAEhD,QAAIP,SAAAA,IAAI,YAAY;AAClB,UAAI,YAAY,KAAK,WAAW,iBAAiB;AAEjDQ,kCAAY,GAAG,SAAS,CAAC,QAAQ,IAAI,YAAY,KAAK,WAAW,GAAG,CAAC;AACrEA,kCAAY,GAAG,uBAAuB,MAAM,IAAI,YAAY,KAAK,WAAW,qBAAqB,CAAC;AAClGA,sBAAAA,YAAY,GAAG,oBAAoB,CAAC,SAAS,IAAI,YAAY,KAAK,WAAW,oBAAoB,IAAI,CAAC;AACtGA,sBAAAA,YAAY,GAAG,wBAAwB,CAAC,SAAS,IAAI,YAAY,KAAK,WAAW,wBAAwB,IAAI,CAAC;AAC9GA,sBAAAA,YAAY,GAAG,qBAAqB,CAAC,SAAS,IAAI,YAAY,KAAK,WAAW,qBAAqB,IAAI,CAAC;AACxGA,sBAAAA,YAAY,GAAG,qBAAqB,CAAC,SAAS,IAAI,YAAY,KAAK,WAAW,qBAAqB,IAAI,CAAC;AAExGD,eAAAA,QAAQ,GAAG,iBAAiB,MAAMC,gBAAAA,YAAY,gBAAgB;AAE9D,iBAAW,MAAMA,gBAAAA,YAAY,gBAAA,GAAmB,GAAI;AACpD,kBAAY,MAAMA,gBAAAA,YAAY,gBAAA,GAAmB,MAAO,KAAK,EAAE;AAAA,IACjE;AAAA,EACF,CAAC;AAED,eAAA;AAEAD,WAAAA,QAAQ,OAAO,gBAAgB,MAAM,eAAe;AACpDA,WAAAA,QAAQ,OAAO,wBAAwB,MAAMD,GAAAA,kBAAA,CAAmB;AAChEC,WAAAA,QAAQ,OAAO,cAAc,MAAM,OAAO,OAAO;AAEjDA,WAAAA,QAAQ,OAAO,gBAAgB,OAAO,IAAwB,SAA4C;AACxG,WAAO,IAAI,QAAQ,OAAO,SAAS,WAAW;AAC5C,UAAI,aAAa;AACjB,iBAAW,YAAY;AACvB,iBAAW,UAAU;AACrB,UAAI;AACF,cAAM,SAAS,MAAM,SAAA;AACrB,gBAAQ,IAAI,0BAA0B,MAAM;AAC5C,0BAAkB;AAClB,gBAAQ,eAAe;AAAA,MACzB,SAAS,OAAO;AACd,eAAO,KAAK;AAAA,MACd;AAAA,IACF,CAAC;AAAA,EACH,CAAC;AAEDA,WAAAA,QAAQ,OAAO,oBAAoB,CAAC,IAAwB,UAAmB;AAC7E,QAAI,OAAO;AACT,aAAO,OAAO,EAAE,KAAK,iBAAiB,OAAO,MAAM;AACnD,aAAO;AAAA,IACT,OAAO;AACL,aAAO,OAAO,EAAE,KAAK,iBAAiB,OAAO,OAAO;AACpD,aAAO;AAAA,IACT;AAAA,EACF,CAAC;AAED,QAAM,cAAc,OAAO,OAAgB,YAAmC;AAC5E,YAAQ,IAAI,iBAAiB,OAAO,OAAO;AAC3C,WAAO,IAAI,QAAQ,OAAO,SAAS,WAAW;AAC5C,UAAI,SAAS,SAAS;AACpB,YAAI,aAAa;AACjB,mBAAW,UAAU;AACrB,mBAAW,UAAU;AAAA,MACvB;AAEA,YAAM,0BAA0B,CAAC,QAAuB;AACtD,gBAAQ,IAAI,gBAAgB,GAAG;AAC/B,kBAAU,eAAe,qBAAqB,uBAAuB;AACrE,gBAAQ,IAAI,IAAI;AAAA,MAClB;AAEA,iBAAW,MAAM;AACf,kBAAU,eAAe,qBAAqB,uBAAuB;AACrE,eAAO,uBAAuB;AAAA,MAChC,GAAG,GAAI;AAEP,gBAAU,GAAG,qBAAqB,uBAAuB;AAEzD,aAAO,OAAO,EAAE,KAAK,eAAe,OAAO,OAAO,QAAQ;AAAA,IAC5D,CAAC;AAAA,EACH;AAEAA,mBAAQ,OAAO,aAAa,OAAO,IAAwB,YAAoB,MAAM,YAAY,MAAM,OAAO,CAAC;AAC/GA,WAAAA,QAAQ,OAAO,cAAc,YAAY,MAAM,YAAY,KAAK,CAAC;AAEjEP,eAAI,GAAG,YAAY,MAAM;AACvB,QAAIK,SAAAA,cAAc,cAAA,EAAgB,WAAW,EAAG,cAAA;AAAA,EAClD,CAAC;AACH,CAAC;AAEDL,SAAAA,IAAI,GAAG,aAAa,MAAM,OAAO,KAAK,SAAS,CAAC;AAEhDA,SAAAA,IAAI,GAAG,qBAAqB,MAAM;AAChC,MAAI,QAAQ,aAAa,SAAUA,UAAAA,IAAI,KAAA;AACzC,CAAC;"}